$(function ()  {

    $(window).scroll(function () {
        var
            scrT = $(this).scrollTop();

        if(scrT > 190) {
            $('.header').addClass('fixed');
            setTimeout(function () {
                $('.header').addClass('fixedF');
            }, 100);
        } else {
            $('.header').removeClass('fixed');
            $('.header').removeClass('fixedF');
        }


        if(scrT > 900) {
            $('.to__top').fadeIn(200);
        } else {
            $('.to__top').fadeOut(200);
        }

        var
            wH = $(window).height(),
            whS = wH + scrT,
            point = $('.point');

        if(point.length > 1) {
            point.each(function () {
                var
                    pT = $(this).offset().top,
                    pH = $(this).height() + pT,
                    id = $(this).attr('id'),
                    ank = $('a[href="#'+id+'"]');

                if(whS >= pT && whS < pH) {
                    $('.ankor a').removeClass('pointerCur');
                    ank.addClass('pointerCur');
                }
            });
        }
    });



    if(window.location.hash) {
        var
            hash = window.location.hash,
            pop = $(hash);

        if(pop.length > 0) {
            $('.popupList').addClass('notTr');
            pop.show();
            $('body').addClass('overHide');
            setTimeout(function () {
                pop.addClass('opened');
            }, 200);
        }
    }


    if($('.lrm-user-modal').length > 0) {
        $('.lrm-user-modal').prepend(('<div class="liginTop"><div class="loginTopT">Авторизація</div><a href="#" onclick="closeLog()" class="lrm-close-formn"></a></div>'))
    }


    $(document).on("scroll", function(){
        var pixels = $(document).scrollTop();
        var pageHeight = $(document).height() - $(window).height();
        var progress = 100 * pixels / pageHeight;

        $("div.progress").css("width", progress + "%");
    });



    $('a.ankor, .ankor a').click(function (e) {
        e.preventDefault();
        var
            thisAnk = $(this).attr('href'),
            $target = $(thisAnk),
            offset = $target.offset().top,
            head = 110;

        if($(window).width() < 980) {
            head = 0;
        }

        var
            ofF = offset - head;

        $('body').removeClass('openedNav');

        $('html, body').stop().animate({'scrollTop': ofF}, 1000, 'swing', function () {

        });
    });


    if($('.parallax').length > 0) {
        $(window).scroll(function () {
            var
                scrollTop = $(this).scrollTop();

            $('.parallaxSec').each(function () {
                var
                    offT = $(this).offset().top,
                    topPos = scrollTop - offT;

                $(this).find('.parallax').css({'top' : topPos+'px'})
            })
        });

    }


    if($(".about__carousel").length > 0) {
        aboutCarousell();
    }

    if($(".reviews__carousel").length > 0) {
        revCarousell();
    }


    //Reviews
    if($('#review_form_wrapper').length > 0) {


        $('#submit').prop('disabled', true);

        var
            thisSpan = $('.comment-form-rating .stars').find('span');

        $('.stars a').hover(function () {
            var
                thisClass = $(this).text();

            $('.comment-form-rating label').removeClass('error');


            thisSpan.removeAttr('class');
            thisSpan.addClass('star-'+thisClass);

        });


        $('.comment-form-rating .stars').mouseleave(function () {
            var
                active = $(this).find('.active').text();

            thisSpan.removeAttr('class');
            thisSpan.addClass('star-'+active);
        });


        $('#commentform input, #commentform textarea').focus(function () {
            $(this).removeClass('error');
        });


        $('.comment-form-rating .stars a').click(function (e) {
            e.preventDefault();

            var
                $this = $(this),
                thCl = $this.text(),
                stars = $this.closest('.stars'),
                sel = $('#rating');

            $this.addClass('active');
            $this.siblings().removeClass('active');
            stars.addClass('star-'+thCl);
            sel.val(thCl);
            $('.comment-form-rating').removeClass('error');
        });


        $('li.review').each(function () {
            var
                ratCont = $(this).find('.star-rating'),
                ratN = ratCont.find('.rating').text();

            ratCont.html('<div class="stars"><span class="star-'+ratN+'"><span class="star-1"></span><span class="star-2"></span><span class="star-3"></span><span class="star-4"></span><span class="star-5"></span></span></div>')
        });

        $('#comment').focusin(function () {
            $('.comment-form-comment').removeClass('error');
        });
    }



    // $("input[type='tel']").mask("+380 (99) 999-99-99");


    var url = new URL(window.location.href);
    if (url.searchParams.has('somresetpass')) {
        var
            pop = $('.reset__popcont');

        if(pop.length > 0) {
            var
                input = pop.find('input'),
                ind = 0,
                btnCont = pop.find('.lostpassword-submit');

            btnCont.prepend('<a href="#" class="button green" onclick="subReset()">Змінити пароль</a>')
            $('body').addClass('overHide');

            input.each(function () {
                var
                    inpt = $(this);

                if(ind === 0) {
                    inpt.attr('placeholder', 'Новий пароль');
                    ind = ind + 1;
                } else {
                    inpt.attr('placeholder', 'Повторіть пароль');
                }

                inpt.after('<a href="#" class="hide-password" onclick="showPass($(this))"></a>');
            });

            input.focusin(function () {
                $('.errorMatch').removeClass('errorMatch');
                $('.resErText').remove();
            });


            $('.lrm-signin-section .lrm-form-bottom-message').addClass('flexJ');
            $('.lrm-signin-section .lrm-form-bottom-message').append('<a href="#" onclick="openRes()">Ввести новий пароль</a>');

            if($('.som-password-error-message').length > 0) {
                $('.som-password-error-message').html('Цей ключ вже не дійсний для відновлення паролю. Спробуйти <a onclick="openForg()" href="#">відправити запит</a> ще раз.');
                $('.som-password-error-message').fadeIn(0);
            }
        }
    }


    $('.saveAcc').click(function(e) {
        e.preventDefault();

        var
            $this = $(this);

        $('.woocommerce-notices-wrapper').html('');
        $this.find('span').text('Збереження...');

        //Ajax function
        jQuery.ajax({
            type: 'POST',
            url: '/wp-admin/admin-ajax.php',
            dataType: 'html',
            data: jQuery(".edit-account").serialize(),
            success : function( response ) {
                if(response !== 'Пароль неправильний' && response !== 'Введіть новий пароль' && response !== 'Паролі не співпадають') {
                    $('.woocommerce-notices-wrapper').html(response);

                    $('.password__popup').fadeOut(400);
                    $('body').removeClass('overHide');
                    $('.password__popup input').val('');
                } else {
                    if(response === 'Пароль неправильний') {
                        $('.currPass').addClass('error');
                        $('.currPass .error__mess').html(response);
                    }
                    if(response === 'Введіть новий пароль') {
                        $('.pass1').addClass('error');
                        $('.pass1 .error__mess').html(response);
                    }
                    if(response === 'Паролі не співпадають') {
                        $('.pass2').addClass('error');
                        $('.pass2 .error__mess').html(response);
                    }
                }

                $('.adddata__cont').remove();
                $this.find('span').text('Збережено');
            }

        });

        $('.passpop__form input').click(function () {
            $('.error').removeClass('error');
        });
    });


    if($('.msgForm').length > 0) {

        var wtf = $('#msgsBox');
        var height = wtf[0].scrollHeight;
        wtf.scrollTop(height);

        $(".msgText").bind("propertychange change click keyup input paste", function(event){
            var
                len = $(this).val().length;

            $('.chatCounter').text(len);

            if(len > 1) {
                $('.chat__send').removeAttr('disabled');
            } else {
                $('.chat__send').attr('disabled', 'disabled');
            }
        });
    }


    if($('.viewOrder').length > 0) {
        var
            tab = getUrlVars()["tab"],
            ww = $(window).width(),
            tabCont = $('#'+tab);

        if(tabCont.length > 0) {
            $('.noTab').addClass('hideOnMob');
            $('.acount__main').removeClass('hideOnMob');
            tabCont.addClass('active');
            $('.woocommerce-MyAccount-navigation a[href="#'+tab+'"]').closest('li').addClass('is-active');

            if(tab === 'translation') {
                var wtf2 = $('#msgsBox');
                var height2 = wtf[0].scrollHeight;
                wtf2.scrollTop(height2);
            }
        } else {
            $('.section__account').addClass('noChosed');
            $('.noTab').removeClass('hideOnMob');
            if($('.courseSide').length < 1) {
                if($('#translation').length > 0) {
                    $('#translation').addClass('active');
                    $('.woocommerce-MyAccount-navigation a[href="#translation"]').closest('li').addClass('is-active');
                } else {
                    $('#test').addClass('active');
                    $('.woocommerce-MyAccount-navigation a[href="#test"]').closest('li').addClass('is-active');
                }
            } else {
                if($('#chapter1').length > 0) {
                    $('#chapter1').addClass('active');
                    $('.woocommerce-MyAccount-navigation a[href="#chapter1"]').closest('li').addClass('is-active');
                } else {
                    $('#test').addClass('active');
                    $('.woocommerce-MyAccount-navigation a[href="#test"]').closest('li').addClass('is-active');
                }
            }

            if(ww < 981) {
                $('.acount__main').addClass('hideOnMob');
            } else {
                var wtf3 = $('#msgsBox');
                var height3 = wtf[0].scrollHeight;
                wtf3.scrollTop(height3);
            }
        }

        if(tab.length === 0) {
            $(window).resize(function () {
                var
                    wr = $(this).width();

                if(wr < 981) {
                    $('.acount__main').addClass('hideOnMob');
                } else {
                    $('.acount__main').removeClass('hideOnMob');
                }
            });
        }
    }

    $(document).on('facetwp-refresh', function() {
        $('html, body').animate({
            scrollTop: $('.library__main').offset().top
        }, 'slow');
    });


    if($('#billing_wooccm11_field').length > 0) {
        var checkboxLabel = $('#billing_wooccm11_field label');
        checkboxLabel.html(checkboxLabel.html().replace('правилами проведення заходу', '<a href="https://gynecology.com.ua/webinar_instructions/" target="_blank">правилами проведення заходу</a>'));
    }

});


function getUrlVars() {
    var vars = [], hash;
    var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
    for(var i = 0; i < hashes.length; i++) {
        hash = hashes[i].split('=');
        vars.push(hash[0]);
        vars[hash[0]] = hash[1];
    }
    return vars;
}



//Open nav
function openNav() {
    event.preventDefault();

    $('body').toggleClass('openedNav');
}


//Open article
function latestClick($this) {
    event.preventDefault();

    var
        id = $this.data().id,
        popup = $('#'+id);

    window.location.hash = id;
    popup.fadeIn(0);
    popup.addClass('opened');
    $('body').addClass('overHide');
}


function closePopup() {
    event.preventDefault();

    var uri = window.location.toString();
    var clean_uri = uri.substring(0, uri.indexOf("#"));

    window.history.replaceState({}, document.title, clean_uri);

    $('.popup').removeClass('opened');
    $('.popup').fadeOut(600);
    $('body').removeClass('overHide');
}



//Gallery
function openPopup($this) {
    event.preventDefault();

    var
        popup = $('.popup');

    if(!$this.hasClass('overlay')) {
        var
            id = $this.attr('href');

        popup = $(id);
    } else {
        popup = $this.closest('.popup');
    }

    popup.fadeToggle(400);
    $('body').toggleClass('overHide');

    if(popup.hasClass('carPop')) {
        var
            car = popup.find('.owl-carousel');
        setTimeout(function () {
            stopGalCarousel(car);
        }, 500);
    }
}


function openImg($this) {
    event.preventDefault();

    var
        gal = $this.closest('.gallery'),
        index = $this.data().index,
        newItem = '',
        items = null;

    if(gal.hasClass('owl-carousel')) {
        items = gal.find('.owl-item:not(.cloned)');

        items.each(function () {
            var
                itemUrl = $(this).find('.falitem'),
                src = itemUrl.attr('href');

            newItem += '<div class="popGalItem"><img onclick="zoom($(this))" src="'+src+'" alt=""><div onclick="openPopup($(this))" class="overlay"></div></div>'
        });
    } else {
        items = gal.find('.falitem');

        items.each(function () {
            var
                src = $(this).attr('href');

            newItem += '<div class="popGalItem"><img onclick="zoom($(this))" src="'+src+'" alt=""><div onclick="openPopup($(this))" class="overlay"></div></div>'
        });
    }

    $('#gal__popup .gallery__carousel').html(newItem);
    galCarousell(index);

    setTimeout(function () {
        $('#gal__popup').fadeIn(400);
        $('body').toggleClass('overHide');
    }, 400);

}


//Galery carousell
function galCarousell(index) {
    var owl = $(".gallery__carousel").owlCarousel({
        smartSpeed: 500,
        mouseDrag: false,
        autoplay: false,
        center: false,
        addClassActive : true,
        loop: false,
        items: 1,
        dots: false,
        nav: true,
        dotsEach: 1,
        margin: 18,
        touchDrag: true,
        dotsSpeed: 300,
        stagePadding: 0,
        startPosition: index,
        responsive : {
            0 : {
                nav: false,
            },
            1116 : {
                nav: true,
            }
        }
    });
}

function stopGalCarousel($this) {
    var owl = $this;
    owl.trigger('destroy.owl.carousel');
    owl.addClass('disabledCar');
}

function zoom($this) {
    $this.toggleClass('zoomed');
    $this.closest('.popGalItem').toggleClass('zoomedIt');
}



//Main carousell
function aboutCarousell() {
    var owl = $(".about__carousel").owlCarousel({
        smartSpeed: 500,
        mouseDrag: false,
        autoplay: true,
        center: false,
        addClassActive : true,
        loop: true,
        dots: false,
        nav: false,
        animateOut: 'fadeOut',
        autoplayTimeout: 4000,
        autoplaySpeed: 1000,
        dotsEach: 1,
        items: 1,
        margin: 0,
        touchDrag: false,
        dotsSpeed: 500,
        stagePadding: 0
    });
}

//Reviews carousell
function revCarousell() {
    var owl = $(".reviews__carousel").owlCarousel({
        smartSpeed: 300,
        mouseDrag: false,
        autoplay: false,
        center: false,
        addClassActive : true,
        loop: false,
        dots: true,
        nav: true,
        animateOut: 'fadeOut',
        dotsEach: 1,
        items: 1,
        margin: 0,
        touchDrag: false,
        dotsSpeed: 300,
        stagePadding: 0
    });
}


function subRev($this) {
    event.preventDefault();

    var
        ratingCont = $('.comment-form-rating'),
        ratingN = ratingCont.find('#rating').val(),
        commentCont = $('.comment-form-comment'),
        comment = $('#comment'),
        comVal = comment.val(),
        errors = 0;

    if(ratingN < 0 || ratingN === '') {
        ratingCont.addClass('error');

        errors = errors + 1;
    }

    if(comVal.length < 1) {
        commentCont.addClass('error');

        errors = errors + 1;
    }

    if(errors === 0 && !$this.hasClass('dis')) {
        $('#submit').removeAttr('disabled');
        $('#submit').click();
        $('#commentform').submit();
        $this.addClass('dis');
    }
}



function applyCoup($this) {
    event.preventDefault();

    var
        form = $this.closest('.couponForm'),
        input = form.find('input').val(),
        mForm = $('#couponform'),
        mInput = mForm.find('input'),
        mSub = mForm.find('button');

    mInput.val(input);
    mSub.click();
}


function openFilter() {
    event.preventDefault();

    $('.library__aside').fadeToggle(300);
    $('body').toggleClass('overHide');
}


//----------------
//----------------
//----------------


function closeLog() {
    event.preventDefault();

    $('.lrm-user-modal').removeClass('is-visible');
    $('body').removeClass('overHide');
}

function showPass($this) {
    event.preventDefault();

    var
        par = $this.closest('p'),
        inp = par.find('input');

    if(!$this.hasClass('hide-password--on')) {
        $this.addClass('hide-password--on');
        inp.attr('type', 'text');
    } else {
        $this.removeClass('hide-password--on');
        inp.attr('type', 'password');
    }
}



function subReset() {
    event.preventDefault();

    var
        pop = $('.reset__popcont'),
        input = pop.find('.somfrp-lost-pass-form-text + div input'),
        ind = 0,
        pass1 = '',
        pass2 = '';


    input.each(function () {
        var
            inpt = $(this);

        if(ind === 0) {
            pass1 = inpt.val();
            ind = ind + 1;
        } else if(ind = 1) {
            pass2 = inpt.val();
        }
    });

    if(pass1 === pass2) {
        pop.find('button').click();
        document.cookie = "passchanged=true; path=/";
    } else {
        input.addClass('errorMatch');
        input.eq(1).after('<span class="resErText">Паролі не збігаються</span>')
    }
}


function closePass() {
    event.preventDefault();

    $('.reset__popup').fadeOut(0);
    $('body').removeClass('overHide');
}

function gotPass() {
    event.preventDefault();

    $('.reset__popup').hide();
    $('.lrm-user-modal').addClass('is-visible');
    $('.lrm-signin-section').addClass('is-selected');
    $('.lrm-signin-section').siblings().removeClass('is-selected');
    $('.lrm-switch-to--login').addClass('selected');
}

function openForg() {
    event.preventDefault();

    $('.reset__popup').hide();
    $('.lrm-user-modal').addClass('is-visible');
    $('.lrm-reset-password-section').addClass('is-selected');
    $('.lrm-reset-password-section').siblings().removeClass('is-selected');
    $('.lrm-switch-to--login').addClass('selected');
}

function openRes() {
    event.preventDefault();

    $('.reset__popup').show();
    $('.lrm-user-modal').removeClass('is-visible');
}


///////////////////
///////////////////
///////////////////
function openPassPop() {
    event.preventDefault();

    $('.password__popup').fadeToggle(400);
    $('body').toggleClass('overHide');
    $('.password__popup input').val('');
}

function openCoursePop() {
    event.preventDefault();

    $('#coursePopup').fadeToggle(400);
    $('body').toggleClass('overHide');

    var
        name = $('.ticket__title').text(),
        url = window.location.href;

    $.ajax({
        type: 'POST',
        url: '/wp-admin/admin-ajax.php',
        dataType: 'html',
        data: {
            action: 'course',
            name: name,
            url: url,
        },
        success: function() {

        }
    });
}


function changeOrderTab($this) {
    event.preventDefault();

    var
        href = $this.attr('href'),
        urlPart = href.replace('#', '');

    var currentUrl = window.location.href;
    var url = new URL(currentUrl);
    url.searchParams.set("tab", urlPart);
    var newUrl = url.href;

    window.location.href = newUrl;
}


/////////////////////
/////////////////////
/////////////////////
function startTest($this) {
    event.preventDefault();

    var
        page = $this.data().id,
        order = $this.data().order,
        fst = $this.data().fst;

    $('.start__testcont').addClass('hideTest');

    setTimeout(function () {
        $.ajax({
            type: 'POST',
            url: '/wp-admin/admin-ajax.php',
            dataType: 'html',
            data: {
                action: 'test__start',
                page: page,
                order: order,
                fst: fst,
            },
            success: function(res) {
                $('#testCont').html(res);
                setTimeout(function () {
                    $('.test__listcont').addClass('showed');
                }, 100);
            }
        });
    }, 300);
}


function unDis($this) {
    var
        name = $this.attr('name'),
        block = $('#quest'+name),
        btn = block.find('.testans__button');

    btn.removeClass('disabled');
}


function answerTest($this) {
    event.preventDefault();

    if(!$this.hasClass('disabled')) {
        var
            page = $this.data().id,
            num = $this.data().num,
            nextNum = num + 1,
            question = $('#quest'+num),
            variant = question.find('input:checked').val();

        question.removeClass('activeQ');
        setTimeout(function () {
            question.removeClass('activeQB');

            $('#sq'+num).addClass('passed');
            $('#sq'+nextNum).addClass('active');
            $('#quest'+nextNum).addClass('activeQB');
            setTimeout(function () {
                $('#quest'+nextNum).addClass('activeQ');
            }, 100);
        }, 300);
    }
}


function endTest($this) {
    event.preventDefault();

    if(!$this.hasClass('disabled')) {
        var
            page = $this.data().id,
            order = $this.data().order,
            form = $('.test__form').serialize();

        $('.test__listcont').removeClass('showed');

        setTimeout(function () {

            $.ajax({
                type: 'POST',
                url: '/wp-admin/admin-ajax.php',
                dataType: 'html',
                data: {
                    action: 'test__end',
                    page: page,
                    order: order,
                    form: form
                },
                success: function(res) {
                    $('.test__container').html(res);
                    var sertForm = $('#sertificateForm');
                    if(sertForm.length > 0) {
                        generateCert(sertForm)
                    }
                    setTimeout(function () {
                        $('.start__testcont').removeClass('hideTest');
                    }, 100);
                }
            });
        }, 300);
    }
}


function generateCert(sertForm) {
    var
        ser = sertForm.serialize();

    $.ajax({
        type: 'GET',
        url: '/wp-content/themes/kdm/certificat/generator.php',
        data: ser,
        success: function() {
            console.log('Sertificat generated');
        }
    });
}



function fullScreen($this) {
    event.preventDefault();

    $this.closest('.trreck__inner').toggleClass('fullde');
    $('body').toggleClass('overHide');
    $('body').toggleClass('overHideVideo');

    if(!$this.hasClass('fulledIcon')) {
        var elem = document.documentElement;
        if (elem.requestFullscreen) { // стандартний метод
            elem.requestFullscreen();
        } else if (elem.webkitRequestFullscreen) { // Safari
            elem.webkitRequestFullscreen();
        } else if (elem.msRequestFullscreen) { // IE11
            elem.msRequestFullscreen();
        }
    } else {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
        }
    }

    $this.toggleClass('fulledIcon');
}


function changeRole(name,value,days) {
    var expires = "";
    if (days) {
        var date = new Date();
        date.setTime(date.getTime() + (days*24*60*60*1000));
        expires = "; expires=" + date.toUTCString();
    }
    document.cookie = name + "=" + (value || "")  + expires + "; path=/";

    location.reload();
}


function searchToggle() {
    event.preventDefault();

    $('.search__container').slideToggle(300);
}


function desdData($this) {
    event.preventDefault();

    var error = 0;
    $(".fst__form input, .fst__form textarea").each(function () {
        var val = $(this).val();

        if(val === '') {
            $(this).addClass('error');
            error = error + 1;
        }
    });

    $('input, textarea').focus(function () {
       $('.error').removeClass('error');
    });

    if(error === 0) {
        jQuery.ajax({
            type: 'POST',
            url: '/wp-admin/admin-ajax.php',
            dataType: 'html',
            data: jQuery(".fst__form").serialize(),
            success : function( response ) {
                $('.test__listcont').removeClass('showed');
                $('.test__listcont').addClass('hideTest');

                startTest($this);
            }

        });
    }
}